<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë‚˜ë¬´ í‚¤ìš°ê¸° â€” í•˜ë£¨ ì¼ê¸° ì €ë„ (v1.1.2)</title>
<style>
  :root{--bg:#0b0d14;--panel:#0f1420;--ink:#e7ebf0;--muted:#9fb0c3;--accent:#93e06b;--pink:#ff82c0;--fruit:#ffb24d;--warn:#ff6b6b}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,'Noto Sans KR',sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:3;background:rgba(11,13,20,.75);backdrop-filter:saturate(160%) blur(10px);border-bottom:1px solid #202835}
  .bar{max-width:980px;margin:0 auto;padding:16px;display:flex;gap:12px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 16px var(--accent)}
  h1{font-size:18px;margin:0;font-weight:800}
  main{max-width:980px;margin:18px auto;padding:16px;display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
  @media (max-width:900px){main{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid #202835;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .card>.hd{padding:14px 16px;border-bottom:1px solid #202835;display:flex;gap:10px;align-items:center}
  .card>.bd{padding:16px}
  .muted{color:var(--muted);font-size:12px}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .pill{background:#0b1220;border:1px solid #1f2a3c;border-radius:12px;padding:10px}
  .pill .k{display:block;color:var(--muted);font-size:11px}
  .pill .v{font-size:18px;font-weight:800}
  textarea,input[type="text"]{width:100%;padding:12px;border-radius:12px;border:1px solid #233147;background:#0b1220;color:var(--ink);font-size:14px}
  textarea{min-height:120px;resize:vertical}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row>.grow{flex:1}
  .btn{appearance:none;border:none;border-radius:12px;background:linear-gradient(180deg,#2ecc71,#27ae60);color:#0b0d14;font-weight:800;padding:12px 16px;cursor:pointer;box-shadow:0 8px 16px rgba(39,174,96,.35)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.secondary{background:linear-gradient(180deg,#7aa0c4,#517fa4);color:#fff}
  .btn.warn{background:linear-gradient(180deg,#ff9b9b,#ff6b6b);color:#1b0c0c}
  .hint{font-size:12px;color:var(--muted)}
  .tree-wrap{position:relative;height:420px;background:radial-gradient(1200px 420px at 50% -50%, #22324a 0%, #0b0d14 60%);border-radius:16px;overflow:hidden;border:1px solid #202835}
  .overlay-msg{position:absolute;bottom:12px;left:12px;font-size:12px;color:var(--muted)}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #203047;background:#0c1320}
  .legend{position:absolute;top:12px;right:12px;display:flex;gap:8px}
  .legend .dot{width:10px;height:10px;border-radius:50%}
  .space{height:8px}
</style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="dot"></div>
      <div>
        <h1>ë‚˜ë¬´ í‚¤ìš°ê¸° â€” í•˜ë£¨ ì¼ê¸°</h1>
        <div class="muted">ê¸€ ì“°ë©´ ë‚˜ë¬´ê°€ ìë¼ë‚©ë‹ˆë‹¤. ë³´ìƒì€ ê°€ë³ê²Œ Â· ê¸°ë¡ì€ ì˜¨ì „íˆ ë‚´ ê²ƒ.</div>
      </div>
    </div>
  </header>
  <main>
    <section class="card">
      <div class="hd"><strong>ì˜¤ëŠ˜ì˜ ì¼ê¸°</strong><span class="muted">(í•˜ë£¨ 1íšŒ ê¸‰ì–‘ê¶Œ)</span></div>
      <div class="bd">
        <label class="hint">ë‹¨ì–´(ì”¨ì•—) â€” ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„: ì˜ˆ) ê°ì‚¬, ë°°ì›€, ìš´ë™</label>
        <input id="seedWords" type="text" placeholder="ì˜¤ëŠ˜ì˜ ì”¨ì•— ë‹¨ì–´" />
        <div class="space"></div>
        <label class="hint">ì¼ê¸°(ì–‘ë¶„) â€” 40ì ì´ìƒ +10, 120ì ì´ìƒ ì¶”ê°€ +10</label>
        <textarea id="journal" placeholder="ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”..."></textarea>
        <div class="space"></div>
        <div class="row">
          <div class="grow hint">ë³´ìƒ: ê¸°ë³¸+10, ë‹¨ì–´Ã—3, 40ì+10, 120ì ì¶”ê°€+10. í•˜ë£¨ í•œ ë²ˆë§Œ.</div>
          <button id="feedBtn" class="btn">ë‚˜ë¬´ì—ê²Œ ë¨¹ì´ ì£¼ê¸°</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd"><strong>ì„±ì¥ ìƒíƒœ</strong> <span class="muted" id="todayInfo"></span></div>
      <div class="bd">
        <div class="stats">
          <div class="pill"><span class="k">ì—°ì† ì¼ìˆ˜</span><span id="streak" class="v">0</span></div>
          <div class="pill"><span class="k">ì´ ì–‘ë¶„</span><span id="nutrients" class="v">0</span></div>
          <div class="pill"><span class="k">ê½ƒ</span><span id="blooms" class="v">0</span></div>
          <div class="pill"><span class="k">ì—´ë§¤</span><span id="fruits" class="v">0</span></div>
        </div>
        <div class="space"></div>
        <div class="tree-wrap">
          <svg id="treeSvg" viewBox="0 0 600 400" width="100%" height="100%" preserveAspectRatio="xMidYMid meet"></svg>
          <div class="legend">
            <span class="badge"><span class="dot" style="background:var(--pink)"></span>ê½ƒ</span>
            <span class="badge"><span class="dot" style="background:var(--fruit)"></span>ì—´ë§¤</span>
            <span class="badge"><span class="dot" style="background:var(--accent)"></span>ìƒˆì‹¹</span>
          </div>
          <div class="overlay-msg" id="overlayMsg">ì”¨ì•— ë‹¨ì–´ë¥¼ ì‹¬ê³  ì¼ê¸°ë¥¼ ì“°ë©´ ì„±ì¥í•´ìš”.</div>
        </div>
        <div class="space"></div>
        <div id="history" class="hint">ìµœê·¼ ê¸°ë¡ ì—†ìŒ</div>
        <div class="space"></div>
        <div class="row">
          <button class="btn secondary" id="exportBtn">ë‚´ë³´ë‚´ê¸°(JSON)</button>
          <button class="btn" id="importBtn">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
          <input type="file" id="importFile" accept="application/json" style="display:none" />
          <button class="btn" id="demoBtn" title="ì˜ˆì‹œ ë°ì´í„°ë¡œ ê½ƒÂ·ì—´ë§¤ ìƒíƒœë¥¼ ë³´ì—¬ì¤˜ìš”">ë°ëª¨: ì—´ë§¤ ë³´ì—¬ì£¼ê¸°</button>
          <button class="btn" id="undoBtn" title="ë§ˆì§€ë§‰ ê¸‰ì–‘ ë˜ëŒë¦¬ê¸°">ë˜ëŒë¦¬ê¸°</button>
          <button class="btn" id="graceBtn" title="ì£¼ 1íšŒ ê²°ì„ ë³´ì •">ê·¸ë ˆì´ìŠ¤ë°ì´</button>
          <button class="btn warn" id="resetBtn" title="ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤">ì´ˆê¸°í™”</button>
          <span class="hint">ë°ì´í„°ëŠ” ì´ ë¸Œë¼ìš°ì €ì˜ localStorageì— ì €ì¥ë©ë‹ˆë‹¤.</span>
        </div>
      </div>
    </section>
  </main>

<script>
(function(){
  // =====================
  // 1) Seeded RNG (top to avoid TDZ on __seed)
  // =====================
  let __seed = 0; // initialized before any srandom/rand call
  function initSeed(createdAt){ const base = String(createdAt||'0').split('').reduce((a,c)=>a+c.charCodeAt(0),0); __seed = base>>>0; }
  function srandom(){ __seed = (__seed*1664525+1013904223)>>>0; return (__seed & 0xffff)/0x10000; }
  function rand(n){ return srandom()*n; }

  // =====================
  // 2) Core boot
  // =====================
  const DB_KEY = 'treeJournal.v1.1';
  const todayStr = localYMD(new Date());

  const state = loadState();
  ensureToday();
  updateUI();
  drawTree();

  // =====================
  // 3) Events
  // =====================
  document.getElementById('feedBtn').addEventListener('click', onFeed);
  document.getElementById('exportBtn').addEventListener('click', onExport);
  document.getElementById('resetBtn').addEventListener('click', onReset);
  document.getElementById('demoBtn').addEventListener('click', seedDemo);
  document.getElementById('importBtn').addEventListener('click', ()=>document.getElementById('importFile').click());
  document.getElementById('importFile').addEventListener('change', onImport);
  document.getElementById('undoBtn').addEventListener('click', onUndo);
  document.getElementById('graceBtn').addEventListener('click', onGrace);

  // =====================
  // 4) State helpers
  // =====================
  function defaultState(){
    return {
      createdAt: new Date().toISOString(),
      lastFed: null,
      totalNutrients: 0,
      streak: 0,
      blooms: 0,
      fruits: 0,
      graceTokens: 1,
      lastGraceWeek: null,
      days: {}
    };
  }
  function loadState(){ try{ const raw = localStorage.getItem(DB_KEY); return raw? JSON.parse(raw): defaultState(); } catch{ return defaultState(); } }
  function saveState(){ localStorage.setItem(DB_KEY, JSON.stringify(state)); }

  // =====================
  // 5) Date
  // =====================
  function localYMD(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function ensureToday(){ document.getElementById('todayInfo').textContent = `ì˜¤ëŠ˜: ${todayStr}`; }

  // =====================
  // 6) Feed
  // =====================
  function onFeed(){
    if(state.lastFed === todayStr){ toast('ì˜¤ëŠ˜ì€ ì´ë¯¸ ê¸‰ì–‘í–ˆì–´ìš”. ë‚´ì¼ ë‹¤ì‹œ ğŸŒ±'); return; }
    const words = (document.getElementById('seedWords').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    const journal = (document.getElementById('journal').value||'').trim();
    let score = 10 + words.length*3; if(journal.length>=40) score+=10; if(journal.length>=120) score+=10;
    state.days[todayStr] = {words, journal, nutrients: score};
    state.totalNutrients += score;
    // streak
    const yest = new Date(new Date().getTime()-86400000); const yestStr = localYMD(yest);
    state.streak = (state.lastFed===yestStr)? state.streak+1 : 1;
    state.lastFed = todayStr;
    // milestones
    const b0=state.blooms, f0=state.fruits;
    if(state.streak%3===0 || state.totalNutrients >= (state.blooms+1)*150) state.blooms++;
    if(state.streak%7===0 || state.totalNutrients >= (state.fruits+1)*400) state.fruits++;

    saveState(); updateUI(); drawTree();
    const dB=state.blooms-b0, dF=state.fruits-f0; toast(`+${score} ì–‘ë¶„ Â· ìƒˆ ê½ƒ ${Math.max(0,dB)} Â· ìƒˆ ì—´ë§¤ ${Math.max(0,dF)}`);
    document.getElementById('seedWords').value=''; document.getElementById('journal').value='';
  }

  // =====================
  // 7) UI
  // =====================
  function updateUI(){
    qs('#streak').textContent = state.streak; qs('#nutrients').textContent = state.totalNutrients; qs('#blooms').textContent = state.blooms; qs('#fruits').textContent = state.fruits;
    const overlay = qs('#overlayMsg'); const feedBtn = qs('#feedBtn');
    if(!state.lastFed){ overlay.textContent='ì²« ì”¨ì•—ì„ ì‹¬ê³  ì¼ê¸°ë¥¼ ì¨ë³´ì„¸ìš”!'; feedBtn.disabled=false; }
    else if(state.lastFed!==todayStr){ overlay.textContent='ì˜¤ëŠ˜ì˜ ê¸‰ì–‘ì´ ì•„ì§ ì—†ì–´ìš”. ë‚˜ë¬´ê°€ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘â€¦'; feedBtn.disabled=false; }
    else { overlay.textContent='ì˜í–ˆì–´ìš”! ì˜¤ëŠ˜ë„ íŠ¼íŠ¼í•˜ê²Œ ìë¼ë‚˜ìš”.'; feedBtn.disabled=true; }
    renderHistory();
  }

  // =====================
  // 8) Export / Import / Undo / Grace / Reset
  // =====================
  function onExport(){
    const data=JSON.stringify(state,null,2);
    const blob=new Blob([data],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`tree-journal-${todayStr}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url),5000);
  }
  async function onImport(ev){
    const file=ev.target.files?.[0]; if(!file) return;
    try{ const text=await file.text(); const obj=JSON.parse(text); Object.assign(state,obj); saveState(); updateUI(); drawTree(); toast('JSON ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ'); }
    catch(e){ console.warn(e); toast('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: JSON í™•ì¸'); }
    finally { ev.target.value=''; }
  }
  function onUndo(){
    if(!state.lastFed||!state.days[state.lastFed]){ toast('ë˜ëŒë¦´ ê¸°ë¡ì´ ì—†ì–´ìš”'); return; }
    const rec=state.days[state.lastFed];
    state.totalNutrients-=rec.nutrients||0;
    delete state.days[state.lastFed];
    state.streak=Math.max(0,state.streak-1);
    state.lastFed=null;
    saveState(); updateUI(); drawTree(); toast('ë§ˆì§€ë§‰ ê¸‰ì–‘ì„ ë˜ëŒë ¸ì–´ìš”');
  }
  function weekKey(d){ const dt=new Date(d); const onejan=new Date(dt.getFullYear(),0,1); const day=Math.floor((dt-onejan)/86400000)+onejan.getDay()+1; const week=Math.ceil(day/7); return `${dt.getFullYear()}-W${week}`; }
  function onGrace(){
    const now=new Date(); const wk=weekKey(now);
    if(state.lastGraceWeek!==wk){ state.graceTokens=1; }
    if(state.graceTokens<=0){ toast('ì´ë²ˆ ì£¼ ê·¸ë ˆì´ìŠ¤ë°ì´ë¥¼ ì´ë¯¸ ì‚¬ìš©í–ˆì–´ìš”'); return; }
    if(state.lastFed===todayStr){ toast('ì˜¤ëŠ˜ì€ ì´ë¯¸ ê¸°ë¡í–ˆì–´ìš”'); return; }
    state.streak=Math.max(1,state.streak+1);
    state.lastFed=todayStr; state.lastGraceWeek=wk; state.graceTokens-=1;
    saveState(); updateUI(); drawTree(); toast('ê·¸ë ˆì´ìŠ¤ë°ì´ ì‚¬ìš©: ì—°ì†ì¼ì„ ìœ ì§€í–ˆì–´ìš”');
  }
  function performReset(){
    // core logic extracted so tests can assert without user prompts
    localStorage.removeItem(DB_KEY);
    const fresh = defaultState();
    // replace state object in-place to preserve references
    for(const k in state) { delete state[k]; }
    Object.assign(state, fresh);
    saveState(); updateUI(); drawTree(); toast('ì´ˆê¸°í™” ì™„ë£Œ');
  }
  function onReset(){
    if(!confirm('ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”? ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.')) return;
    performReset();
  }

  // =====================
  // 9) History
  // =====================
  function renderHistory(){
    const box=qs('#history');
    const entries=Object.entries(state.days).sort((a,b)=>a[0]<b[0]?1:-1).slice(0,5);
    if(entries.length===0){ box.textContent='ìµœê·¼ ê¸°ë¡ ì—†ìŒ'; return; }
    const lines=entries.map(([d,r])=>`${d} Â· +${r.nutrients}ì  Â· ë‹¨ì–´ ${r.words.length}ê°œ`);
    box.textContent='ìµœê·¼: '+lines.join(' | ');
  }

  // =====================
  // 10) Toast
  // =====================
  function toast(msg){ const t=document.createElement('div'); t.textContent=msg; Object.assign(t.style,{position:'fixed',bottom:'16px',left:'50%',transform:'translateX(-50%)',background:'#121a28',border:'1px solid #203047',color:'var(--ink)',padding:'10px 14px',borderRadius:'12px',boxShadow:'0 8px 24px rgba(0,0,0,.35)',zIndex:99}); document.body.appendChild(t); setTimeout(()=>t.remove(),2200); }

  // =====================
  // 11) SVG Tree
  // =====================
  function drawTree(){
    initSeed(state.createdAt);
    const svg = qs('#treeSvg'); svg.innerHTML='';
    const level = growthLevel();
    rect(290,260,20,120,'#5b4636');
    const branchCount=3+level*2; for(let i=0;i<branchCount;i++){ const y=260-i*18; const dir=(i%2===0)?1:-1; const len=50+i*6+level*10; branch(300,y,300+dir*len,y-20,'#6a513f',3+level*0.3); }
    const leafCount=20+level*20; for(let i=0;i<leafCount;i++){ const x=240+rand(120)+(srandom()<.5?-1:1)*rand(120); const y=120+rand(180); leaf(x,y,'#7bd389'); }
    for(let i=0;i<state.blooms;i++){ const x=180+rand(240); const y=100+rand(180); circle(x,y,5+rand(4),'var(--pink)'); }
    for(let i=0;i<state.fruits;i++){ const x=200+rand(200); const y=120+rand(160); fruit(x,y,6+rand(6)); }
    ellipse(300,380,220,24,'#0f1a26');
    function rect(x,y,w,h,fill){ add('rect',{x,y,width:w,height:h,rx:6,fill}); }
    function branch(x1,y1,x2,y2,stroke,w){ add('line',{x1,y1,x2,y2,stroke,'stroke-width':w,'stroke-linecap':'round'}); }
    function circle(cx,cy,r,fill){ add('circle',{cx,cy,r,fill,opacity:.9}); }
    function leaf(x,y,fill){ const r=6+rand(4); add('ellipse',{cx:x,cy:y,rx:r,ry:r*0.6,fill,opacity:.9}); }
    function fruit(cx,cy,r){ add('circle',{cx,cy,r,fill:'var(--fruit)'}); add('rect',{x:cx-1.2,y:cy-r-6,width:2.4,height:6,fill:'#6a513f'}); }
    function ellipse(cx,cy,rx,ry,fill){ add('ellipse',{cx,cy,rx,ry,fill,opacity:.8}); }
    function add(tag,attrs){ const el=document.createElementNS('http://www.w3.org/2000/svg',tag); for(const k in attrs) el.setAttribute(k,attrs[k]); svg.appendChild(el); return el; }
    function growthLevel(){ const n=state.totalNutrients; if(n>=1200) return 5; if(n>=800) return 4; if(n>=500) return 3; if(n>=300) return 2; if(n>=120) return 1; return 0; }
  }

  // =====================
  // 12) Demo
  // =====================
  function seedDemo(){
    const today=new Date(); const mk=(d)=>localYMD(d);
    state.days={}; let total=0;
    for(let i=6;i>=0;i--){ const d=new Date(today.getTime()-i*86400000); const key=mk(d); const words=['ê°ì‚¬','ë°°ì›€','í‰ì˜¨']; const journal='ë°ëª¨ ì¼ê¸°ì…ë‹ˆë‹¤. 60ì ì´ìƒìœ¼ë¡œ ì±„ì›Œ ë³´ë„ˆìŠ¤ë¥¼ ë°›ëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤.'; const score=10 + words.length*3 + 10; state.days[key]={words,journal,nutrients:score}; total+=score; }
    state.totalNutrients=total; state.lastFed=todayStr; state.streak=7; state.blooms=2; state.fruits=1;
    saveState(); updateUI(); drawTree(); toast('ë°ëª¨ ì ìš©: ê½ƒ 2ê°œ, ì—´ë§¤ 1ê°œ ğŸ');
  }

  // =====================
  // 13) Utils & Self-tests
  // =====================
  function qs(sel){ return document.querySelector(sel); }

  // ---- Lightweight self-tests (console only; no user data mutation) ----
  try {
    // Test 1: RNG should not throw and be in [0,1)
    initSeed('2025-01-01T00:00:00.000Z');
    const r1=srandom(); const r2=srandom();
    console.assert(r1>=0 && r1<1 && r2>=0 && r2<1, 'RNG out of range');
    // Test 2: localYMD format
    console.assert(/^\d{4}-\d{2}-\d{2}$/.test(localYMD(new Date())), 'localYMD format error');
    // Test 3: scoring examples
    function score(wordsCount,len){ let s=10+wordsCount*3; if(len>=40) s+=10; if(len>=120) s+=10; return s; }
    console.assert(score(0,20)===10,'score case1');
    console.assert(score(2,45)===26,'score case2');
    console.assert(score(3,60)===29,'score case3');
    console.assert(score(5,130)===45,'score case4');
    // Test 4: drawTree should not throw
    drawTree();
    // Test 5: onReset must exist (do not call it to avoid user data loss)
    console.assert(typeof onReset==='function','onReset not defined');
    console.log('[Self-tests] All tests passed');
  } catch(e){ console.error('[Self-tests] FAILED', e); }

})();
</script>
</body>
</html>
