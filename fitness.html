<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìš´ë™ ì¹´ìš´í„° (íŒ”êµ½í˜€í´ê¸°Â·ì² ë´‰)</title>
  <style>
    :root {
      --bg:#0b0d14; --fg:#e7ebf0; --muted:#93a1b3; --accent:#6ee7b7; --danger:#f87171;
      --card:#111827; --border:#1f2937;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:System-ui,-apple-system,Segoe UI,Roboto,Pretendard,'Noto Sans KR',sans-serif;background:var(--bg);color:var(--fg)}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    header{position:sticky;top:0;background:rgba(11,13,20,.7);backdrop-filter:saturate(160%) blur(10px);border-bottom:1px solid var(--border);z-index:10}
    h1{font-size:22px;margin:12px 0}
    .grid{display:grid;gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
    select,button,input[type="number"],input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:#0f1420;color:var(--fg);font-size:16px}
    button{cursor:pointer;transition:transform .06s ease,opacity .2s ease}
    button:active{transform:scale(.98)}
    .row{display:flex;gap:10px;align-items:center}
    .row>*{flex:1}
    .counter{
      font-size:80px;font-weight:800;letter-spacing:1px;text-align:center;padding:28px;border-radius:20px;background:#0f1420;border:1px solid var(--border)
    }
    .sub{display:flex;gap:10px;justify-content:space-between;color:var(--muted);font-size:14px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#0f1420}
    .ok{background:rgba(110,231,183,.1);border-color:rgba(110,231,183,.4)}
    .err{background:rgba(248,113,113,.1);border-color:rgba(248,113,113,.4)}
    .big{font-size:20px;font-weight:700}
    .hint{font-size:13px;color:var(--muted)}
    .tapBtn{padding:18px 16px;font-size:22px;font-weight:800}
    .ghost{background:transparent}
    .accent{background:linear-gradient(180deg,#34d39933,#10b98122);border-color:#10b98160}
    .danger{background:linear-gradient(180deg,#f8717133,#ef444422);border-color:#f8717166}
    .muted{color:var(--muted)}
    .stack{display:flex;flex-direction:column;gap:12px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>ğŸ‹ï¸ ìš´ë™ ì¹´ìš´í„° <span class="muted">(íŒ”êµ½í˜€í´ê¸°Â·ì² ë´‰)</span></h1>
    </div>
  </header>
  <main class="wrap grid">
    <section class="card">
      <div class="grid">
        <div class="counter" id="count">0</div>
        <div class="sub">
          <div class="pill" id="modeStatus">ëª¨ë“œ: ìˆ˜ë™ íƒ­</div>
          <div class="pill" id="sensorStatus">ì„¼ì„œ: í™•ì¸ ì¤‘â€¦</div>
        </div>
        <div class="row">
          <div>
            <label for="exercise">ìš´ë™ ì¢…ë¥˜</label>
            <select id="exercise" aria-label="ìš´ë™ ì¢…ë¥˜">
              <option value="pushup">íŒ”êµ½í˜€í´ê¸°</option>
              <option value="pullup">ì² ë´‰(í„±ê±¸ì´)</option>
              <option value="squat">ìŠ¤ì¿¼íŠ¸</option>
            </select>
          </div>
          <div>
            <label for="mode">ì¹´ìš´íŠ¸ ë°©ì‹</label>
            <select id="mode" aria-label="ì¹´ìš´íŠ¸ ë°©ì‹">
              <option value="tap">ìˆ˜ë™ íƒ­</option>
              <option value="voice">ìŒì„±(ë² íƒ€)</option>
              <option value="motion">ëª¨ì…˜(ë² íƒ€)</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="goal">ëª©í‘œ íšŸìˆ˜(ì„ íƒ)</label>
            <input id="goal" type="number" min="1" placeholder="ì˜ˆ: 20" />
          </div>
          <div>
            <label for="threshold">ë¯¼ê°ë„(ëª¨ì…˜)</label>
            <input id="threshold" type="number" step="0.1" min="0.5" value="1.2" />
          </div>
        </div>
        <div class="row">
          <button id="tapBtn" class="tapBtn accent">+1 (íƒ­í•˜ì—¬ ì¹´ìš´íŠ¸)</button>
          <button id="resetBtn" class="danger">ë¦¬ì…‹</button>
        </div>
        <div class="row">
          <button id="startBtn">ì‹œì‘</button>
          <button id="stopBtn" class="ghost">ì •ì§€</button>
        </div>
        <div class="stack">
          <div class="hint">â€¢ íŒŒì¼ì„ ì €ì¥í•´ì„œ ìŠ¤ë§ˆíŠ¸í° ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸° (ë˜ëŠ” ì§€ê¸ˆ ìº”ë²„ìŠ¤ì—ì„œ â€œë‹¤ìš´ë¡œë“œ â†’ íœ´ëŒ€í°ìœ¼ë¡œ ì „ì†¡â€).<br>â€¢ <b>ìˆ˜ë™</b>: ë²„íŠ¼ì„ íƒ­í•˜ê±°ë‚˜ í‚¤ë³´ë“œ <b>ìŠ¤í˜ì´ìŠ¤</b>ë¡œ +1<br>â€¢ <b>ìŒì„±</b>: â€œí•˜ë‚˜/ë‘˜/ì…‹â€¦â€, "ì¹´ìš´íŠ¸" ë“± ë§í•˜ë©´ +1 (ê¶Œí•œ í•„ìš”)<br>â€¢ <b>ëª¨ì…˜</b>: ìŠ¤ë§ˆíŠ¸í°ì„ ëª¸ì— ê³ ì •(ì£¼ë¨¸ë‹ˆ/íŒ”ë°´ë“œ). í”¼í¬ ê°ì§€ë¡œ ìë™ +1 (iOSëŠ” ê¶Œí•œ í•„ìš”)</div>
          <details>
            <summary>ì„¤ì • & ì‚¬ìš© íŒ</summary>
            <ul>
              <li>íŒ”êµ½í˜€í´ê¸°: ê°€ìŠ´ì´ ë°”ë‹¥ì— ê°€ê¹Œì›Œì§ˆ ë•Œ ê°€ì¥ í¬ê²Œ ì›€ì§ì´ë‹ˆ í°ì„ ì£¼ë¨¸ë‹ˆë‚˜ ìƒì˜ì— ê³ ì •í•˜ì„¸ìš”.</li>
              <li>ì² ë´‰: í°ì„ ì£¼ë¨¸ë‹ˆì— ë„£ê³  í„±ì´ ì˜¬ë¼ê°ˆ ë•Œ ê°€ì† ë³€í™”ê°€ í½ë‹ˆë‹¤. ë¯¼ê°ë„ë¥¼ ì¡°ì •í•˜ì„¸ìš”.</li>
              <li>ëª©í‘œë¥¼ ì±„ìš°ë©´ ìë™ìœ¼ë¡œ ì§„ë™/ë¹„í”„ í”¼ë“œë°±.</li>
              <li>ì •í™•ë„ê°€ ë‚®ìœ¼ë©´ <b>ìˆ˜ë™ íƒ­</b>ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ê¸°ë¡í•˜ì„¸ìš”.</li>
            </ul>
          </details>
        </div>
      </div>
    </section>
  </main>

  <script>
  // --- State ---
  const el = (id)=>document.getElementById(id);
  const countEl = el('count');
  const modeSel = el('mode');
  const exerciseSel = el('exercise');
  const sensorStatus = el('sensorStatus');
  const modeStatus = el('modeStatus');
  const tapBtn = el('tapBtn');
  const resetBtn = el('resetBtn');
  const startBtn = el('startBtn');
  const stopBtn = el('stopBtn');
  const goalInput = el('goal');
  const thresholdInput = el('threshold');

  let count = 0;
  let running = false;
  let lastTick = 0;
  let refractoryMs = 600; // ìµœì†Œ ê°„ê²©(ì¤‘ë³µ ë°©ì§€)
  let audioCtx, beepOsc;
  let recognizer; // SpeechRecognition
  let motionHandler;

  function updateCount(n){
    count = Math.max(0, n);
    countEl.textContent = String(count);
    pulse(countEl);
    haptic(10);
    beep(0.02, 660);
    const goal = parseInt(goalInput.value||'0',10);
    if(goal && count>=goal){
      celebrate();
    }
    localStorage.setItem('repCounter', JSON.stringify({count,mode:modeSel.value,exercise:exerciseSel.value,goal:goalInput.value,threshold:thresholdInput.value}));
  }

  function inc(){
    const now=Date.now();
    if(now-lastTick<refractoryMs) return; // ë””ë°”ìš´ìŠ¤
    lastTick=now; updateCount(count+1);
  }

  function reset(){ updateCount(0); }

  function pulse(node){
    node.animate([{transform:'scale(1)'},{transform:'scale(1.04)'},{transform:'scale(1)'}],{duration:140});
  }

  function haptic(ms){ if(navigator.vibrate) navigator.vibrate(ms); }

  function initBeep(){
    if(!audioCtx){
      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    }
  }
  function beep(dur=0.05, freq=880){
    try{
      initBeep();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type='sine'; o.frequency.value=freq;
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.15, audioCtx.currentTime+0.005);
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+dur);
      o.start(); o.stop(audioCtx.currentTime+dur+0.01);
    }catch(e){}
  }

  function celebrate(){
    haptic([60,60,60]);
    for(let i=0;i<3;i++) setTimeout(()=>beep(0.06, 600+i*120), i*90);
  }

  // --- UI wiring ---
  tapBtn.addEventListener('click', inc);
  resetBtn.addEventListener('click', reset);
  document.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); inc(); }});

  startBtn.addEventListener('click', ()=>{
    running=true; setupMode();
  });
  stopBtn.addEventListener('click', ()=>{
    running=false; teardownMode();
  });

  modeSel.addEventListener('change', ()=>{ if(running){ setupMode(); } updateModeStatus(); });
  exerciseSel.addEventListener('change', ()=>{ /* reserved for per-exercise tuning */ });

  function updateModeStatus(){ modeStatus.textContent = 'ëª¨ë“œ: ' + (
    modeSel.value==='tap' ? 'ìˆ˜ë™ íƒ­' : modeSel.value==='voice' ? 'ìŒì„±(ë² íƒ€)' : 'ëª¨ì…˜(ë² íƒ€)'
  ); }

  // --- Voice mode ---
  function startVoice(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ sensorStatus.className='pill err'; sensorStatus.textContent='ìŒì„± ì¸ì‹ ë¯¸ì§€ì›'; return; }
    recognizer = new SR();
    recognizer.lang='ko-KR';
    recognizer.interimResults=false; recognizer.continuous=true;
    recognizer.onresult=(ev)=>{
      for(const res of ev.results){
        const t = res[0].transcript.trim();
        if(/(í•˜ë‚˜|ë‘˜|ì…‹|ë„·|ë‹¤ì„¯|ì—¬ì„¯|ì¼ê³±|ì—¬ëŸ|ì•„í™‰|ì—´|ì¹´ìš´íŠ¸|ì‹œì‘|ì—…|ë‹¤ìš´)/.test(t)){
          inc();
        }
      }
    };
    recognizer.onend=()=>{ if(running && modeSel.value==='voice') recognizer.start(); };
    recognizer.start();
    sensorStatus.className='pill ok'; sensorStatus.textContent='ìŒì„± ì¸ì‹ ë™ì‘ ì¤‘';
  }

  function stopVoice(){ if(recognizer){ try{recognizer.onend=null; recognizer.stop();}catch(e){} recognizer=null; } }

  // --- Motion mode ---
  let lastAcc = {x:0,y:0,z:0};
  let lpf = {x:0,y:0,z:0};
  const alpha=0.2; // LPF ê³„ìˆ˜

  async function ensureMotionPermission(){
    try{
      if(typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
        const state = await DeviceMotionEvent.requestPermission();
        return state==='granted';
      }
      return true; // ì•ˆë“œ/ë°ìŠ¤í¬íƒ‘ì€ ê¶Œí•œ í”„ë¡¬í”„íŠ¸ ì—†ìŒ
    }catch(e){ return false; }
  }

  function startMotion(){
    motionHandler = (ev)=>{
      const a = ev.accelerationIncludingGravity || ev.acceleration || {x:0,y:0,z:0};
      // ì €ì—­í†µê³¼ë¡œ ë…¸ì´ì¦ˆ ì™„í™”
      lpf.x = alpha*a.x + (1-alpha)*lpf.x;
      lpf.y = alpha*a.y + (1-alpha)*lpf.y;
      lpf.z = alpha*a.z + (1-alpha)*lpf.z;
      const dx = lpf.x - lastAcc.x;
      const dy = lpf.y - lastAcc.y;
      const dz = lpf.z - lastAcc.z;
      lastAcc = {x:lpf.x,y:lpf.y,z:lpf.z};

      // ìš´ë™ë³„ ì£¼ìš” ì¶• ê°€ì¤‘ì¹˜
      const ex = exerciseSel.value;
      let axisMag;
      if(ex==='pushup') axisMag = Math.abs(dz); // ìœ„/ì•„ë˜ ë³€í™”
      else if(ex==='pullup') axisMag = Math.abs(dy); // ìˆ˜ì§ ë°©í–¥
      else axisMag = Math.max(Math.abs(dx), Math.abs(dy), Math.abs(dz)); // ìŠ¤ì¿¼íŠ¸ ë“± ì¼ë°˜

      const th = parseFloat(thresholdInput.value || '1.2');
      if(axisMag>th) inc();
    };
    window.addEventListener('devicemotion', motionHandler, {passive:true});
    sensorStatus.className='pill ok'; sensorStatus.textContent='ëª¨ì…˜ ê°ì§€ ë™ì‘ ì¤‘';
  }

  function stopMotion(){ if(motionHandler){ window.removeEventListener('devicemotion', motionHandler); motionHandler=null; } }

  async function setupMode(){
    teardownMode();
    updateModeStatus();
    if(modeSel.value==='voice'){
      startVoice();
    }else if(modeSel.value==='motion'){
      const ok = await ensureMotionPermission();
      if(ok){ startMotion(); }
      else { sensorStatus.className='pill err'; sensorStatus.textContent='ëª¨ì…˜ ê¶Œí•œ ê±°ë¶€'; }
    }else{
      sensorStatus.className='pill'; sensorStatus.textContent='ì„¼ì„œ: í•„ìš” ì—†ìŒ';
    }
  }

  function teardownMode(){ stopVoice(); stopMotion(); }

  // --- Restore state ---
  try{
    const saved = JSON.parse(localStorage.getItem('repCounter')||'null');
    if(saved){
      count = saved.count||0; countEl.textContent=String(count);
      if(saved.mode) modeSel.value = saved.mode;
      if(saved.exercise) exerciseSel.value = saved.exercise;
      if(saved.goal) goalInput.value = saved.goal;
      if(saved.threshold) thresholdInput.value = saved.threshold;
    }
  }catch(e){}
  updateModeStatus();

  // Accessibility labels for screen readers on count change
  const live = document.createElement('div');
  live.className='sr-only'; live.setAttribute('role','status'); live.setAttribute('aria-live','polite');
  document.body.appendChild(live);
  const observer = new MutationObserver(()=>{ live.textContent = `í˜„ì¬ íšŸìˆ˜ ${count}`; });
  observer.observe(countEl,{characterData:true,childList:true});
  </script>
</body>
</html>
